// -----------------------------------------------------
// CONFIGURAÇÕES PRISMA
// -----------------------------------------------------

generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// ENUMS
// -----------------------------------------------------

// Status atual do carro disponível para viagens
enum StatusCarro {
  DISPONIVEL
  EM_USO        @map("EM USO")
  EM_MANUTENCAO @map("EM MANUTENCAO")
}

// Classificação dos veículos
enum TipoCarro {
  VAN
  MINIVAN
  HATCH
  SEDAN
  SUV
}

// Categorias de mensagens enviadas via ouvidoria
enum CategoriaMensagemOuvidoria {
  DENUNCIA
  SOLICITACAO
  SUGESTAO
  RECLAMACAO
  ELOGIO
}

// Status de uma solicitação de viagem
enum StatusSolicitacaoViagem {
  PENDENTE
  CONFIRMADA
  REALIZADA
  CANCELADA
}

// Tipo geral de solicitação
enum TipoSolicitacao {
  VIAGEM
  OUVIDORIA
  CONSULTA
}

// Categoria das notícias do portal
enum CategoriaNoticia {
  SAUDE
  EDUCACAO
  INFRAESTRUTURA
  CULTURA
  ESPORTE
}

// -----------------------------------------------------
// USUÁRIO, FUNCIONÁRIO E FUNÇÕES
// -----------------------------------------------------

// Usuário geral do sistema (pacientes, cidadãos, funcionários)
model Usuario {
  idUsuario          Int           @id @default(autoincrement())
  primeiroNome       String
  sobrenome          String
  cpf                String        @unique @db.Char(11)
  telefone           String        @db.Char(11)
  email              String        @unique
  senha              String
  endereco           String
  telefoneConfirmado Boolean       @default(false)
  emailConfirmado    Boolean       @default(false)
  createdAt          DateTime      @default(now())
  AcompanhantePaciente AcompanhantePaciente[]

  Funcionario Funcionario[]
  Solicitacao Solicitacao[]
}

// Funcionário (ex.: motorista, administrativo etc.)
model Funcionario {
  idFuncionario     Int                 @id @default(autoincrement())
  Usuario_idUsuario Int
  pis               Int?
  matricula         Int?

  Usuario           Usuario             @relation(fields: [Usuario_idUsuario], references: [idUsuario], onDelete: Cascade)
  FuncionarioFuncao FuncionarioFuncao[]
  Viagem            Viagem[]

  @@index([Usuario_idUsuario])
}

// Funções atribuídas aos funcionários
model Funcao {
  idFuncao          Int                 @id @default(autoincrement())
  nome              String
  FuncionarioFuncao FuncionarioFuncao[]
}

// Tabela pivot Funcionario <-> Função
model FuncionarioFuncao {
  Funcionario_idFuncionario Int
  Funcao_idFuncao           Int

  Funcao      Funcao      @relation(fields: [Funcao_idFuncao], references: [idFuncao], onDelete: Cascade)
  Funcionario Funcionario @relation(fields: [Funcionario_idFuncionario], references: [idFuncionario], onDelete: Cascade)

  @@id([Funcionario_idFuncionario, Funcao_idFuncao])
  @@index([Funcao_idFuncao])
}

// -----------------------------------------------------
// SOLICITAÇÕES (SUPER-ENTIDADE)
// -----------------------------------------------------

// Solicitação genérica (pode ser viagem, consulta, ouvidoria...)
model Solicitacao {
  idSolicitacao             Int                 @id @default(autoincrement())
  Usuario_idUsuario         Int
  primeiro_nome_solicitante String
  sobrenome_solicitante     String
  email_solicitante         String
  telefone_solicitante      String
  TipoSolicitacao           TipoSolicitacao

  Usuario           Usuario             @relation(fields: [Usuario_idUsuario], references: [idUsuario], onDelete: Cascade)
  MensagemOuvidoria MensagemOuvidoria[]
  PedidoConsulta    PedidoConsulta[]
  SolicitacaoViagem SolicitacaoViagem[]

  @@index([Usuario_idUsuario])
}

// -----------------------------------------------------
// OUVIDORIA
// -----------------------------------------------------

model MensagemOuvidoria {
  idMensagemOuvidoria        Int                        @id @default(autoincrement())
  Solicitacao_idSolicitacao  Int

  assunto                    String
  mensagem                   String
  nomeSolicitante            String?
  emailSolicitante           String?
  numeroProtocolo            String?                    @db.Char(15)
  status                     String?
  CategoriaMensagemOuvidoria CategoriaMensagemOuvidoria

  Solicitacao                Solicitacao @relation(fields: [Solicitacao_idSolicitacao], references: [idSolicitacao], onDelete: Cascade)

  @@index([Solicitacao_idSolicitacao])
}

// -----------------------------------------------------
// CONSULTAS / UBS
// -----------------------------------------------------

model UnidadeUbs {
  idUnidadeUbs            Int                       @id @default(autoincrement())
  nome_unidade            String
  endereco_unidade        String

  EspecialidadeUnidadeUbs EspecialidadeUnidadeUbs[]
  PedidoConsulta          PedidoConsulta[]
}

model Especialidade {
  idEspecialidade         Int                       @id @default(autoincrement())
  nome_especialidade      String
  EspecialidadeUnidadeUbs EspecialidadeUnidadeUbs[]
}

// Pivot Especialidade <-> Unidade UBS
model EspecialidadeUnidadeUbs {
  Especialidade_idEspecialidade Int
  UnidadeUbs_idUnidadeUbs       Int

  Especialidade Especialidade @relation(fields: [Especialidade_idEspecialidade], references: [idEspecialidade], onDelete: Cascade)
  UnidadeUbs    UnidadeUbs    @relation(fields: [UnidadeUbs_idUnidadeUbs], references: [idUnidadeUbs], onDelete: Cascade)

  @@id([Especialidade_idEspecialidade, UnidadeUbs_idUnidadeUbs])
  @@index([UnidadeUbs_idUnidadeUbs])
}

model PedidoConsulta {
  idPedidoConsulta          Int         @id @default(autoincrement())
  UnidadeUbs_idUnidadeUbs   Int
  Solicitacao_idSolicitacao Int

  Solicitacao Solicitacao @relation(fields: [Solicitacao_idSolicitacao], references: [idSolicitacao], onDelete: Cascade)
  UnidadeUbs  UnidadeUbs  @relation(fields: [UnidadeUbs_idUnidadeUbs], references: [idUnidadeUbs])

  @@index([Solicitacao_idSolicitacao])
  @@index([UnidadeUbs_idUnidadeUbs])
}

// -----------------------------------------------------
// VIAGENS
// -----------------------------------------------------

// Pessoa que acompanha o paciente
model Acompanhante {
  idAcompanhante    Int                 @id @default(autoincrement())
  nomeCompleto      String
  endereco          String
  telefone          String              @db.Char(11)
  email             String
  cpf               String              @unique @db.Char(11)
  AcompanhantePaciente AcompanhantePaciente[]

  SolicitacaoViagem SolicitacaoViagem[]
}

// Relação entre acompanhante e paciente (usuário)

model AcompanhantePaciente {
  Acompanhante_idAcompanhante Int
  Usuario_idUsuario           Int

  Acompanhante Acompanhante @relation(fields: [Acompanhante_idAcompanhante], references: [idAcompanhante], onDelete: Cascade)
  Usuario      Usuario      @relation(fields: [Usuario_idUsuario], references: [idUsuario], onDelete: Cascade)

  @@id([Acompanhante_idAcompanhante, Usuario_idUsuario])
  @@index([Usuario_idUsuario])
}

// Solicitações de viagem (subtipo de Solicitação)
model SolicitacaoViagem {     
  idSolicitacaoViagem         Int                     @id @default(autoincrement())
  Solicitacao_idSolicitacao   Int
  Acompanhante_idAcompanhante Int?
  Viagem_idViagem             Int?
  endereco_paciente           String
  local_consulta              String
  cidade_consulta             String
  comprovante_url             String?
  data_consulta               DateTime @db.Date
  horario_consulta            DateTime @db.Time(0)
  motivo_cancelamento         String? 

  StatusSolicitacao StatusSolicitacaoViagem @default(PENDENTE)

  Parada        Parada[]
  Acompanhante  Acompanhante? @relation(fields: [Acompanhante_idAcompanhante], references: [idAcompanhante])
  Solicitacao   Solicitacao   @relation(fields: [Solicitacao_idSolicitacao], references: [idSolicitacao], onDelete: Cascade)
  Viagem        Viagem?       @relation(fields: [Viagem_idViagem], references: [idViagem])

  @@index([Acompanhante_idAcompanhante])
  @@index([Solicitacao_idSolicitacao])
  @@index([Viagem_idViagem])
}

// Viagem (quando uma solicitação vira um transporte real)
model Viagem {
  idViagem                  Int                 @id @default(autoincrement())
  Funcionario_idFuncionario Int
  Carro_idCarro             Int

  dataPartida               DateTime
  enderecoLocalPartida      String

  Parada            Parada[]
  SolicitacaoViagem SolicitacaoViagem[]
  Carro             Carro      @relation(fields: [Carro_idCarro], references: [idCarro])
  Funcionario       Funcionario @relation(fields: [Funcionario_idFuncionario], references: [idFuncionario], onDelete: Cascade)

  @@index([Carro_idCarro])
  @@index([Funcionario_idFuncionario])
}

// Pontos de parada de uma viagem
model Parada {
  idParada                              Int @id @default(autoincrement())
  SolicitacaoViagem_idSolicitacaoViagem Int
  Viagem_idViagem                       Int

  endereco String

  SolicitacaoViagem SolicitacaoViagem @relation(fields: [SolicitacaoViagem_idSolicitacaoViagem], references: [idSolicitacaoViagem], onDelete: Cascade)
  Viagem            Viagem            @relation(fields: [Viagem_idViagem], references: [idViagem])

  @@index([SolicitacaoViagem_idSolicitacaoViagem])
  @@index([Viagem_idViagem])
}

// Informações sobre os carros
model Carro {
  idCarro     Int         @id @default(autoincrement())
  modelo      String
  cor         String
  placa       String      @db.VarChar(10)
  capacidade  Int
  StatusCarro StatusCarro @default(DISPONIVEL)
  TipoCarro   TipoCarro

  Viagem      Viagem[]
}

// -----------------------------------------------------
// CURSOS E EVENTOS
// -----------------------------------------------------

model Curso {
  idCurso        Int      @id @default(autoincrement())
  titulo         String
  descricao      String
  local_curso    String
  imagem_capa    String
  criado_em      DateTime @default(now())
  ativo          Boolean  @default(true)

  IntervaloDatas String
}

model Evento {
  idEvento       Int      @id @default(autoincrement())
  titulo         String
  descricao      String
  local_evento   String
  imagem_capa    String
  criado_em      DateTime @default(now())
  ativo          Boolean  @default(true)
  mesInicio      Int
  IntervaloDatas String
}

// -----------------------------------------------------
// TAXISTAS
// -----------------------------------------------------

model Taxista {
  idTaxista        Int    @id @default(autoincrement())
  nome_taxista     String
  telefone_taxista String
}

// -----------------------------------------------------
// NOTÍCIAS
// -----------------------------------------------------

model Noticia {
  id        Int              @id @default(autoincrement())
  titulo    String
  corpo     String
  imagemUrl String
  autor     String
  categoria CategoriaNoticia
  createdAt DateTime         @default(now())
}
